# bashtard

- name: install packages
  apt: name={{item}} state=present
  with_items:
  - xinetd

- name: copy files
  copy: src="{{local_ctfd_dir}}/services/Bashtard/src/" dest="{{ctfc_service_dir}}/Bashtard"

- name: add xinetd services
  template: src=xinetd-services.j2 dest=/etc/xinetd.d/{{item.name}}
  with_items: 
  - "{{ Bashtard }}"
  tags: services
  notify: restart xinetd

- name: update services list
  lineinfile:
    dest=/etc/services
    line="{{ item.name }}   {{ item.port }}/tcp"
    state=present
    insertafter=EOF
  with_items: 
  - "{{ Bashtard }}"
  tags: services
  notify: restart xinetd

- name: tests service (local)
  command: "nc -v -z -w 1 localhost {{ Bashtard.port }}"
  changed_when: false
  when: run_tests
  tags: tests
  
- name: tests service (delegated)
  command: "nc -v -z -w 1 {{ ansible_default_ipv4.address }} {{ Bashtard.port }}"
  delegate_to: "{{ ctf_gameserver_hostname }}"
  changed_when: false
  when: run_tests
  tags: tests
